<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SimpleCater</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background-color: #ffffff;
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 30px;
        justify-content: center;
        position: relative;
        z-index: 1;
      }

      .dropdown {
        position: relative;
        width: 192px;
        z-index: 10;
      }

      .dropdown-button {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid;
        background-color: #ffffff;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
        border-radius: 8px;
        transition: all 0.2s;
        position: relative;
        z-index: 1;
      }

      .dropdown-button:hover {
        opacity: 0.9;
      }

      .dropdown-button::after {
        content: "â–¼";
        font-size: 10px;
        margin-left: 10px;
        color: #125f43;
      }

      .dropdown.green .dropdown-button {
        border-color: #125f43;
        color: #000;
      }

      .dropdown[data-dropdown="market"] .dropdown-button {
        background-color: #125f431a;
      }

      .dropdown.yellow .dropdown-button {
        border-color: #e5dc84;
        background-color: #e5dc8426;
        color: #333;
      }

      .dropdown.active.green .dropdown-button {
        background-color: #125f4333;
      }

      .dropdown.active.yellow .dropdown-button {
        background-color: #e5dc844d;
      }

      .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #ffffff;
        border: 1px solid;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none !important;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        min-width: 100%;
        width: 100%;
      }

      .dropdown.active .dropdown-menu,
      .dropdown.active.green .dropdown-menu,
      .dropdown.active.yellow .dropdown-menu {
        display: block !important;
      }

      .dropdown.green .dropdown-menu {
        border-color: #125f43;
      }

      .dropdown.yellow .dropdown-menu {
        border-color: #e5dc84;
      }

      .dropdown-item {
        padding: 12px 16px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.2s;
      }

      .dropdown.green .dropdown-item:hover,
      .dropdown.green .dropdown-item.selected {
        background-color: #125f4333;
        color: #125f43;
      }

      .dropdown[data-dropdown="market"] .dropdown-item:hover,
      .dropdown[data-dropdown="market"] .dropdown-item.selected {
        color: #000;
      }

      .dropdown.yellow .dropdown-item:hover,
      .dropdown.yellow .dropdown-item.selected {
        background-color: #e5dc844d;
        color: #333;
      }

      .dropdown-item:first-child {
        border-radius: 8px 8px 0 0;
      }

      .dropdown-item:last-child {
        border-radius: 0 0 8px 8px;
      }

      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 40px;
        margin-bottom: 40px;
      }

      .pagination-button {
        min-width: 40px;
        height: 40px;
        padding: 0 12px;
        border: 1px solid;
        background-color: #f5f5f5;
        border-color: #125f43;
        color: #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        border-radius: 6px;
        transition: all 0.2s;
        font-family: inherit;
      }

      .pagination-button:hover {
        opacity: 0.8;
      }

      .pagination-button.prev,
      .pagination-button.next {
        background-color: #e5dc84;
        border-color: #e5dc84;
      }

      .pagination-button.active {
        background-color: #125f4333;
        border-color: #125f43;
        color: #125f43;
      }

      .pagination-button.ellipsis {
        border: none;
        background-color: transparent;
        cursor: default;
      }

      .pagination-button.ellipsis:hover {
        opacity: 1;
      }

      .pagination-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination-button:disabled:hover {
        opacity: 0.5;
      }

      .card {
        background-color: #125f430d;
        border: 1px solid #125f43;
        border-radius: 8px;
        padding: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(18, 95, 67, 0.15);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
      }

      .card-name {
        font-size: 24px;
        font-weight: 500;
        color: #333;
        flex: 1;
      }

      .card-price {
        font-size: 16px;
        color: #125f43;
        font-weight: 500;
        margin-left: 12px;
      }

      .card-section {
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 0 6px;
        line-height: 1.5;
      }

      .card-section:last-child {
        margin-bottom: 0;
      }

      .card-section-label {
        display: inline-flex;
        align-items: center;
        font-size: 14px;
        color: #125f43;
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .card-section-label svg {
        width: 13px;
        height: 15px;
        margin-right: 8px;
        flex-shrink: 0;
      }

      .card-section-label.leaf svg {
        width: 16px;
        height: 16px;
      }

      .card-tags {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        flex: 1;
        min-width: 0;
      }

      .card-tag {
        background-color: #e5dc8426;
        border: 1px solid #e5dc8480;
        color: #333;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
      }

      .card-dietary {
        font-size: 14px;
        color: #333;
        line-height: 1.5;
        display: inline;
      }

      @media (max-width: 768px) {
        .filters {
          flex-direction: column;
        }

        .dropdown {
          width: 100%;
        }

        .cards-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (min-width: 769px) and (max-width: 1024px) {
        .cards-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (min-width: 1025px) {
        .cards-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="filters">
        <div class="dropdown green" data-dropdown="market">
          <button type="button" class="dropdown-button">
            Select your Market
          </button>
          <div class="dropdown-menu"></div>
        </div>

        <div class="dropdown yellow" data-dropdown="regions">
          <button class="dropdown-button">Regions Available</button>
          <div class="dropdown-menu"></div>
        </div>

        <div class="dropdown yellow" data-dropdown="cuisines">
          <button class="dropdown-button">Cuisines</button>
          <div class="dropdown-menu"></div>
        </div>

        <div class="dropdown yellow" data-dropdown="dietary">
          <button class="dropdown-button">Dietary Preference</button>
          <div class="dropdown-menu"></div>
        </div>
      </div>

      <div class="cards-grid" id="cards-grid">
        <div style="text-align: center; padding: 40px">
          Loading restaurants...
        </div>
      </div>

      <div class="pagination">
        <button class="pagination-button prev">&lt;</button>
        <button class="pagination-button active">1</button>
        <button class="pagination-button">2</button>
        <button class="pagination-button">3</button>
        <button class="pagination-button">4</button>
        <button class="pagination-button">5</button>
        <button class="pagination-button ellipsis">...</button>
        <button class="pagination-button">44</button>
        <button class="pagination-button next">&gt;</button>
      </div>
    </div>

    <script>
      // Use proxy API instead of direct Webflow API
      const API_BASE = "http://localhost:3000/api/webflow";

      // SVG icons as strings
      const potIconSVG = `<svg width="13" height="15" viewBox="0 0 13 15" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.3478 1H8.10088V4.88902e-07H4.3478V1ZM11.1986 3.23197L11.2225 3.30354L12.1711 2.98701L12.1471 2.91544L11.1986 3.23197ZM1.22617 3.30354L1.25005 3.23197L0.301468 2.91544L0.277588 2.98701L1.22617 3.30354ZM5.52902 14.3333H6.91961V13.3333H5.52902V14.3333ZM10.5577 4.22625H1.89099V5.22625H10.5577V4.22625ZM1.39626 4.79867L2.39573 11.6254L3.38519 11.4805L2.38571 4.65381L1.39626 4.79867ZM10.0529 11.6254L11.0524 4.79867L10.0629 4.65381L9.06348 11.4805L10.0529 11.6254ZM6.91961 14.3333C7.45621 14.3333 7.90542 14.3343 8.26562 14.2889C8.63982 14.2417 8.98008 14.1383 9.27075 13.8871L8.61688 13.1305C8.53208 13.2038 8.40981 13.2627 8.14055 13.2967C7.85735 13.3324 7.48221 13.3333 6.91961 13.3333V14.3333ZM9.06348 11.4805C8.98195 12.0371 8.92668 12.4082 8.85035 12.6833C8.77775 12.9447 8.70168 13.0572 8.61688 13.1305L9.27075 13.8871C9.56148 13.6359 9.71302 13.3141 9.81388 12.9507C9.91102 12.6009 9.97522 12.1563 10.0529 11.6254L9.06348 11.4805ZM0.277588 2.98701C0.175368 3.29334 0.0836947 3.56539 0.037168 3.79069C-0.010552 4.02176 -0.0307521 4.28887 0.0922079 4.55259L0.998535 4.13001C1.00924 4.15297 0.986035 4.14049 1.0165 3.99295C1.04817 3.83963 1.11588 3.63405 1.22617 3.30354L0.277588 2.98701ZM1.89099 4.22625C1.54256 4.22625 1.32612 4.22541 1.17067 4.20691C1.02106 4.18911 1.01657 4.16315 1.03496 4.18057L0.347228 4.90653C0.558468 5.10665 0.818241 5.17203 1.05253 5.19991C1.28097 5.22709 1.56805 5.22625 1.89099 5.22625V4.22625ZM0.0922079 4.55259C0.154208 4.68556 0.240721 4.80563 0.347228 4.90653L1.03496 4.18057C1.01975 4.16616 1.00739 4.14901 0.998535 4.13001L0.0922079 4.55259ZM11.2225 3.30354C11.3327 3.63405 11.4005 3.83963 11.4321 3.99295C11.4626 4.14049 11.4394 4.15297 11.4501 4.13001L12.3564 4.5526C12.4794 4.28888 12.4592 4.02176 12.4115 3.79069C12.3649 3.56539 12.2733 3.29335 12.1711 2.98701L11.2225 3.30354ZM10.5577 5.22625C10.8806 5.22625 11.1677 5.22709 11.3961 5.19991C11.6304 5.17203 11.8901 5.10665 12.1014 4.90653L11.4137 4.18057C11.4321 4.16314 11.4276 4.18911 11.2779 4.20691C11.1225 4.22541 10.9061 4.22625 10.5577 4.22625V5.22625ZM11.4501 4.13001C11.4412 4.14901 11.4289 4.16616 11.4137 4.18057L12.1014 4.90653C12.2079 4.80563 12.2944 4.68555 12.3564 4.5526L11.4501 4.13001ZM8.10088 1C8.72355 1 9.15355 1.00059 9.48915 1.03449C9.81428 1.06733 10.0055 1.12807 10.1586 1.22216L10.6823 0.370267C10.3535 0.168147 9.99761 0.0807738 9.58968 0.0395605C9.19221 -0.000592848 8.70335 4.88902e-07 8.10088 4.88902e-07V1ZM12.1471 2.91544C11.9565 2.34393 11.8023 1.87999 11.6384 1.5157C11.4701 1.14176 11.2746 0.831801 10.9788 0.583907L10.3365 1.35034C10.4742 1.46574 10.5923 1.62798 10.7264 1.92597C10.8648 2.2336 11.0015 2.64131 11.1986 3.23197L12.1471 2.91544ZM10.1586 1.22216C10.2209 1.26049 10.2804 1.30333 10.3365 1.35034L10.9788 0.583907C10.8853 0.505554 10.7862 0.434147 10.6823 0.370267L10.1586 1.22216ZM5.52902 13.3333C4.96641 13.3333 4.59131 13.3324 4.30812 13.2967C4.03886 13.2627 3.91656 13.2038 3.83175 13.1305L3.17787 13.8871C3.46858 14.1383 3.80882 14.2417 4.18301 14.2889C4.54324 14.3343 4.99241 14.3333 5.52902 14.3333V13.3333ZM2.39573 11.6254C2.47346 12.1563 2.53762 12.6009 2.63475 12.9507C2.73564 13.3141 2.88715 13.6359 3.17787 13.8871L3.83175 13.1305C3.74695 13.0572 3.6709 12.9447 3.5983 12.6833C3.52194 12.4082 3.46668 12.0371 3.38519 11.4805L2.39573 11.6254ZM4.3478 4.88902e-07C3.74529 4.88902e-07 3.25641 -0.000592848 2.85897 0.0395605C2.45101 0.0807738 2.0951 0.168147 1.76632 0.370267L2.29003 1.22216C2.44309 1.12807 2.63439 1.06733 2.95948 1.03449C3.2951 1.00059 3.72511 1 4.3478 1V4.88902e-07ZM1.25005 3.23197C1.44715 2.6413 1.58382 2.23359 1.72221 1.92597C1.85627 1.62798 1.97443 1.46574 2.11213 1.35034L1.46981 0.583907C1.17402 0.831801 0.978475 1.14176 0.810255 1.51569C0.646368 1.87998 0.492181 2.34392 0.301468 2.91544L1.25005 3.23197ZM1.76632 0.370267C1.66241 0.434147 1.56331 0.505554 1.46981 0.583907L2.11213 1.35034C2.16823 1.30333 2.22769 1.26049 2.29003 1.22216L1.76632 0.370267Z" fill="#125F43"/>
      </svg>`;

      const leafIconSVG = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_20_996)">
          <path d="M12.5043 8.49937C12.5043 3.91191 8.50997 0.282111 8.33991 0.129913C8.14656 -0.0432705 7.85384 -0.0433384 7.66035 0.129913C7.49029 0.282179 3.49573 3.91191 3.49573 8.49937C3.49573 9.60721 3.97433 10.7379 4.8088 11.6017C5.55593 12.3752 6.49371 12.85 7.49077 12.9715V15.4906C7.49077 15.7719 7.71876 15.9999 8.00013 15.9999C8.28151 15.9999 8.5095 15.7719 8.5095 15.4906V12.9715C9.50649 12.85 10.4441 12.3751 11.1912 11.6017C12.0257 10.7379 12.5043 9.60714 12.5043 8.49937ZM5.39959 4.90231L7.49077 6.99369V9.12209L4.81328 6.44426C4.96609 5.90467 5.16834 5.38811 5.39959 4.90231ZM8.5095 9.12277V6.99417L10.6007 4.90279C10.832 5.38886 11.0342 5.90562 11.1871 6.44548L8.5095 9.12277ZM10.101 3.964C10.0929 3.9712 10.0845 3.97812 10.0768 3.98593L8.5095 5.55342V1.77516C8.97709 2.30951 9.56843 3.06086 10.101 3.964ZM7.49077 1.77509V5.55287L5.92397 3.98593C5.91595 3.97799 5.9076 3.97092 5.89925 3.96359C6.43197 3.06052 7.02317 2.30931 7.49077 1.77509ZM4.51446 8.49937C4.51446 8.20944 4.53435 7.92318 4.56913 7.64092L7.49084 10.5628V11.9435C5.75683 11.6647 4.51446 10.0012 4.51446 8.49937ZM8.5095 11.9434V10.5634L11.4309 7.64215C11.4657 7.924 11.4856 8.20985 11.4856 8.49937C11.4855 10.0012 10.2433 11.6647 8.5095 11.9434Z" fill="#125F43"/>
        </g>
        <defs>
          <clipPath id="clip0_20_996">
            <rect width="16" height="16" fill="white" />
          </clipPath>
        </defs>
      </svg>`;

      async function fetchWebflowData(path) {
        try {
          const response = await fetch(`${API_BASE}${path}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.error("Error fetching from Webflow:", error);
          throw error;
        }
      }

      async function getSites() {
        return await fetchWebflowData("/sites");
      }

      async function getCollections(siteId) {
        return await fetchWebflowData(`/sites/${siteId}/collections`);
      }

      async function getCollectionItems(collectionId, offset = 0, limit = 100) {
        const params = new URLSearchParams({
          offset: offset.toString(),
          limit: limit.toString(),
        });
        return await fetchWebflowData(
          `/collections/${collectionId}/items?${params.toString()}`
        );
      }

      // Global storage for mappings
      let allRegions = [];
      let allMarkets = [];
      let cuisinesMap = new Map(); // ID -> name
      let dietariesMap = new Map(); // ID -> name
      let allRestaurants = [];
      let currentPage = 1;
      const restaurantsPerPage = 30;

      function createCardHTML(restaurant) {
        const name =
          restaurant.fieldData?.name || restaurant.name || "Restaurant";
        const price =
          restaurant.fieldData?.["range-price"] ||
          restaurant.fieldData?.price ||
          restaurant.price ||
          "$$";
        const cuisineIds =
          restaurant.fieldData?.["cusiness-category"] ||
          restaurant.fieldData?.cuisines ||
          [];
        const dietaryIds =
          restaurant.fieldData?.["dietary-category"] ||
          restaurant.fieldData?.dietary ||
          [];

        // Map cuisine IDs to names
        const cuisineNames = Array.isArray(cuisineIds)
          ? cuisineIds.map((id) => cuisinesMap.get(id)).filter((name) => name)
          : [];

        // Map dietary IDs to names
        const dietaryNames = Array.isArray(dietaryIds)
          ? dietaryIds.map((id) => dietariesMap.get(id)).filter((name) => name)
          : [];

        const cuisineTags = cuisineNames
          .map((cuisine) => `<span class="card-tag">${cuisine}</span>`)
          .join("");

        const dietaryText = dietaryNames.join(", ");

        return `
          <div class="card">
            <div class="card-header">
              <div class="card-name">${name}</div>
              <div class="card-price">${price}</div>
            </div>
            ${
              cuisineTags
                ? `
            <div class="card-section">
              <div class="card-section-label pot">
                ${potIconSVG}
                Cusiness:
              </div>
              <div class="card-tags">
                ${cuisineTags}
              </div>
            </div>
            `
                : ""
            }
            ${
              dietaryText
                ? `
            <div class="card-section">
              <div class="card-section-label leaf">
                ${leafIconSVG}
                Dietary:
              </div>
              <div class="card-dietary">${dietaryText}</div>
            </div>
            `
                : ""
            }
          </div>
        `;
      }
      // Helper function to parse region name and extract market
      function parseRegionName(regionName) {
        const match = regionName.match(/^(.+?)\s*\[(.+?)\]$/);
        if (match) {
          return {
            displayName: match[1].trim(),
            marketName: match[2].trim(),
          };
        }
        return {
          displayName: regionName,
          marketName: null,
        };
      }

      async function loadRegions() {
        try {
          // Step 1: Get sites
          const sitesResponse = await getSites();
          if (
            !sitesResponse ||
            !sitesResponse.sites ||
            sitesResponse.sites.length === 0
          ) {
            throw new Error("No sites found");
          }
          const siteId = sitesResponse.sites[0].id;

          // Step 2: Get collections
          const collectionsResponse = await getCollections(siteId);
          if (
            !collectionsResponse ||
            !collectionsResponse.collections ||
            collectionsResponse.collections.length === 0
          ) {
            throw new Error("No collections found");
          }

          // Step 3: Find "Restaurants -> Regions" collection by ID or displayName
          const regionsCollection = collectionsResponse.collections.find(
            (col) =>
              col.id === "689ab2ea1e098c7fa15d2353" ||
              col.displayName === "Restaurants -> Regions"
          );

          if (!regionsCollection) {
            console.warn("Restaurants -> Regions collection not found");
            return;
          }

          // Step 4: Fetch all regions with pagination
          allRegions = [];
          let offset = 0;
          const limit = 100;
          let hasMore = true;

          while (hasMore) {
            const regionsResponse = await getCollectionItems(
              regionsCollection.id,
              offset,
              limit
            );

            if (
              !regionsResponse ||
              !regionsResponse.items ||
              regionsResponse.items.length === 0
            ) {
              hasMore = false;
              break;
            }

            allRegions = allRegions.concat(regionsResponse.items);

            // Check if there are more items to fetch
            const pagination = regionsResponse.pagination;
            if (
              !pagination ||
              offset + regionsResponse.items.length >= pagination.total
            ) {
              hasMore = false;
            } else {
              offset += limit;
            }
          }

          console.log(`Loaded ${allRegions.length} regions`);

          // Step 5: Populate regions dropdown with all regions initially
          populateRegionsDropdown();
        } catch (error) {
          console.error("Error loading regions:", error);
        }
      }

      function populateRegionsDropdown(selectedMarketName = null) {
        const regionsDropdown = document.querySelector(
          '[data-dropdown="regions"] .dropdown-menu'
        );
        if (!regionsDropdown) {
          console.warn("Regions dropdown not found");
          return;
        }

        // Save "All Regions" option before clearing
        const allRegionsOption =
          regionsDropdown.querySelector('[data-value="all"]');
        const allRegionsHTML = allRegionsOption
          ? allRegionsOption.outerHTML
          : '<div class="dropdown-item selected" data-value="all">All Regions</div>';

        // Clear and rebuild dropdown
        regionsDropdown.innerHTML = allRegionsHTML;

        // Filter regions based on selected market
        const filteredRegions = selectedMarketName
          ? allRegions.filter((region) => {
              const regionName = region.fieldData?.name || "";
              const parsed = parseRegionName(regionName);
              return parsed.marketName === selectedMarketName;
            })
          : allRegions;

        // Add each region as a dropdown item
        filteredRegions.forEach((region) => {
          const regionName = region.fieldData?.name || "Region";
          const parsed = parseRegionName(regionName);
          const displayName = parsed.displayName;
          const regionId = region.id;

          const regionItem = document.createElement("div");
          regionItem.className = "dropdown-item";
          regionItem.setAttribute("data-value", regionId);
          regionItem.textContent = displayName;
          regionsDropdown.appendChild(regionItem);
        });
      }

      function populateCuisinesDropdown(availableCuisineIds = null) {
        const cuisinesDropdown = document.querySelector(
          '[data-dropdown="cuisines"] .dropdown-menu'
        );
        if (!cuisinesDropdown) {
          console.warn("Cuisines dropdown not found");
          return;
        }

        // Get currently selected value
        const selectedItem = cuisinesDropdown.querySelector(
          ".dropdown-item.selected"
        );
        const selectedValue = selectedItem?.getAttribute("data-value");

        const allCuisinesHTML =
          '<div class="dropdown-item" data-value="all">Cuisines</div>';

        cuisinesDropdown.innerHTML = allCuisinesHTML;

        // Determine which cuisines to show
        const cuisinesToShow =
          availableCuisineIds && availableCuisineIds.size > 0
            ? availableCuisineIds
            : cuisinesMap.keys();

        // Add each cuisine as a dropdown item (only if available or showing all)
        cuisinesMap.forEach((name, id) => {
          if (
            !availableCuisineIds ||
            availableCuisineIds.size === 0 ||
            availableCuisineIds.has(id)
          ) {
            const cuisineItem = document.createElement("div");
            cuisineItem.className = "dropdown-item";
            cuisineItem.setAttribute("data-value", id);
            cuisineItem.textContent = name;
            cuisinesDropdown.appendChild(cuisineItem);
          }
        });

        // Restore selection if it still exists, otherwise select "All"
        const itemToSelect =
          selectedValue &&
          cuisinesDropdown.querySelector(`[data-value="${selectedValue}"]`)
            ? selectedValue
            : "all";

        const item = cuisinesDropdown.querySelector(
          `[data-value="${itemToSelect}"]`
        );
        if (item) {
          cuisinesDropdown
            .querySelectorAll(".dropdown-item")
            .forEach((i) => i.classList.remove("selected"));
          item.classList.add("selected");

          // Update button text
          const button = document.querySelector(
            '[data-dropdown="cuisines"] .dropdown-button'
          );
          if (button) {
            button.textContent = item.textContent.trim();
          }
        }
      }

      function populateDietariesDropdown(availableDietaryIds = null) {
        const dietariesDropdown = document.querySelector(
          '[data-dropdown="dietary"] .dropdown-menu'
        );
        if (!dietariesDropdown) {
          console.warn("Dietaries dropdown not found");
          return;
        }

        // Get currently selected value
        const selectedItem = dietariesDropdown.querySelector(
          ".dropdown-item.selected"
        );
        const selectedValue = selectedItem?.getAttribute("data-value");

        const allDietariesHTML =
          '<div class="dropdown-item" data-value="all">Dietary Preferences</div>';

        dietariesDropdown.innerHTML = allDietariesHTML;

        // Determine which dietaries to show
        const dietariesToShow =
          availableDietaryIds && availableDietaryIds.size > 0
            ? availableDietaryIds
            : dietariesMap.keys();

        // Add each dietary as a dropdown item (only if available or showing all)
        dietariesMap.forEach((name, id) => {
          if (
            !availableDietaryIds ||
            availableDietaryIds.size === 0 ||
            availableDietaryIds.has(id)
          ) {
            const dietaryItem = document.createElement("div");
            dietaryItem.className = "dropdown-item";
            dietaryItem.setAttribute("data-value", id);
            dietaryItem.textContent = name;
            dietariesDropdown.appendChild(dietaryItem);
          }
        });

        // Restore selection if it still exists, otherwise select "All"
        const itemToSelect =
          selectedValue &&
          dietariesDropdown.querySelector(`[data-value="${selectedValue}"]`)
            ? selectedValue
            : "all";

        const item = dietariesDropdown.querySelector(
          `[data-value="${itemToSelect}"]`
        );
        if (item) {
          dietariesDropdown
            .querySelectorAll(".dropdown-item")
            .forEach((i) => i.classList.remove("selected"));
          item.classList.add("selected");

          // Update button text
          const button = document.querySelector(
            '[data-dropdown="dietary"] .dropdown-button'
          );
          if (button) {
            button.textContent = item.textContent.trim();
          }
        }
      }

      async function loadMarkets() {
        try {
          // Step 1: Get sites
          const sitesResponse = await getSites();
          if (
            !sitesResponse ||
            !sitesResponse.sites ||
            sitesResponse.sites.length === 0
          ) {
            throw new Error("No sites found");
          }
          const siteId = sitesResponse.sites[0].id;

          // Step 2: Get collections
          const collectionsResponse = await getCollections(siteId);
          if (
            !collectionsResponse ||
            !collectionsResponse.collections ||
            collectionsResponse.collections.length === 0
          ) {
            throw new Error("No collections found");
          }

          // Step 3: Find "Restaurant -> Markets" collection by ID or displayName
          const marketsCollection = collectionsResponse.collections.find(
            (col) =>
              col.id === "67b4de17bb1baf038e1d10d6" ||
              col.displayName === "Restaurant -> Markets"
          );

          if (!marketsCollection) {
            console.warn("Restaurant -> Markets collection not found");
            return;
          }

          // Step 4: Get items from markets collection
          const marketsResponse = await getCollectionItems(
            marketsCollection.id
          );
          if (
            !marketsResponse ||
            !marketsResponse.items ||
            marketsResponse.items.length === 0
          ) {
            console.warn("No markets found");
            return;
          }

          // Step 5: Populate market dropdown
          const marketDropdown = document.querySelector(
            '[data-dropdown="market"] .dropdown-menu'
          );
          if (!marketDropdown) {
            console.warn("Market dropdown not found");
            return;
          }

          // Save "All Markets" option before clearing
          const allMarketsOption =
            marketDropdown.querySelector('[data-value="all"]');
          const allMarketsHTML = allMarketsOption
            ? allMarketsOption.outerHTML
            : '<div class="dropdown-item selected" data-value="all">All Markets</div>';

          // Clear and rebuild dropdown
          marketDropdown.innerHTML = allMarketsHTML;

          // Store markets globally
          allMarkets = marketsResponse.items;

          // Add each market as a dropdown item
          marketsResponse.items.forEach((market) => {
            const marketName = market.fieldData?.name || "Market";
            const marketSlug = market.fieldData?.slug || market.id;

            const marketItem = document.createElement("div");
            marketItem.className = "dropdown-item";
            marketItem.setAttribute("data-value", marketSlug);
            marketItem.setAttribute("data-market-id", market.id);
            marketItem.setAttribute("data-market-name", marketName);
            marketItem.textContent = marketName;
            marketDropdown.appendChild(marketItem);
          });
        } catch (error) {
          console.error("Error loading markets:", error);
        }
      }

      async function loadCuisines() {
        try {
          const sitesResponse = await getSites();
          if (!sitesResponse?.sites?.length) {
            throw new Error("No sites found");
          }
          const siteId = sitesResponse.sites[0].id;

          const collectionsResponse = await getCollections(siteId);
          if (!collectionsResponse?.collections?.length) {
            throw new Error("No collections found");
          }

          const cuisinesCollection = collectionsResponse.collections.find(
            (col) =>
              col.id === "689ab3186cf4f7e40bbad9db" ||
              col.displayName === "Restaurants -> Cuisinesses"
          );

          if (!cuisinesCollection) {
            console.warn("Cuisines collection not found");
            return;
          }

          cuisinesMap.clear();
          let offset = 0;
          const limit = 100;
          let hasMore = true;

          while (hasMore) {
            const response = await getCollectionItems(
              cuisinesCollection.id,
              offset,
              limit
            );

            if (!response?.items?.length) {
              hasMore = false;
              break;
            }

            response.items.forEach((item) => {
              const id = item.id;
              const name = item.fieldData?.name;
              if (id && name) {
                cuisinesMap.set(id, name);
              }
            });

            const pagination = response.pagination;
            if (
              !pagination ||
              offset + response.items.length >= pagination.total
            ) {
              hasMore = false;
            } else {
              offset += limit;
            }
          }

          console.log(`Loaded ${cuisinesMap.size} cuisines`);
        } catch (error) {
          console.error("Error loading cuisines:", error);
        }
      }

      async function loadDietaries() {
        try {
          const sitesResponse = await getSites();
          if (!sitesResponse?.sites?.length) {
            throw new Error("No sites found");
          }
          const siteId = sitesResponse.sites[0].id;

          const collectionsResponse = await getCollections(siteId);
          if (!collectionsResponse?.collections?.length) {
            throw new Error("No collections found");
          }

          const dietariesCollection = collectionsResponse.collections.find(
            (col) =>
              col.id === "689ab2beeb9650a8d2423e5f" ||
              col.displayName === "Restaurants -> Dietaries"
          );

          if (!dietariesCollection) {
            console.warn("Dietaries collection not found");
            return;
          }

          dietariesMap.clear();
          let offset = 0;
          const limit = 100;
          let hasMore = true;

          while (hasMore) {
            const response = await getCollectionItems(
              dietariesCollection.id,
              offset,
              limit
            );

            if (!response?.items?.length) {
              hasMore = false;
              break;
            }

            response.items.forEach((item) => {
              const id = item.id;
              const name = item.fieldData?.name;
              if (id && name) {
                dietariesMap.set(id, name);
              }
            });

            const pagination = response.pagination;
            if (
              !pagination ||
              offset + response.items.length >= pagination.total
            ) {
              hasMore = false;
            } else {
              offset += limit;
            }
          }

          console.log(`Loaded ${dietariesMap.size} dietaries`);
        } catch (error) {
          console.error("Error loading dietaries:", error);
        }
      }

      async function loadAllRestaurants() {
        try {
          const sitesResponse = await getSites();
          if (!sitesResponse?.sites?.length) {
            throw new Error("No sites found");
          }
          const siteId = sitesResponse.sites[0].id;

          const collectionsResponse = await getCollections(siteId);
          if (!collectionsResponse?.collections?.length) {
            throw new Error("No collections found");
          }

          const restaurantsCollection = collectionsResponse.collections.find(
            (col) =>
              col.id === "689abab143d1746189bc92a2" || col.slug === "restaurant"
          );

          if (!restaurantsCollection) {
            throw new Error("Restaurants collection not found");
          }

          allRestaurants = [];
          let offset = 0;
          const limit = 100;
          let hasMore = true;

          while (hasMore) {
            const response = await getCollectionItems(
              restaurantsCollection.id,
              offset,
              limit
            );

            if (!response?.items?.length) {
              hasMore = false;
              break;
            }

            allRestaurants = allRestaurants.concat(response.items);

            const pagination = response.pagination;
            if (
              !pagination ||
              offset + response.items.length >= pagination.total
            ) {
              hasMore = false;
            } else {
              offset += limit;
            }
          }

          console.log(`Loaded ${allRestaurants.length} restaurants`);
          filterAndDisplayRestaurants();
        } catch (error) {
          console.error("Error loading restaurants:", error);
          const cardsGrid = document.getElementById("cards-grid");
          cardsGrid.innerHTML = `<div style="text-align: center; padding: 40px; color: #d32f2f;">Error loading restaurants: ${error.message}</div>`;
        }
      }

      function getSelectedFilters() {
        const marketDropdown = document.querySelector(
          '[data-dropdown="market"] .dropdown-menu'
        );
        const regionDropdown = document.querySelector(
          '[data-dropdown="regions"] .dropdown-menu'
        );
        const cuisineDropdown = document.querySelector(
          '[data-dropdown="cuisines"] .dropdown-menu'
        );
        const dietaryDropdown = document.querySelector(
          '[data-dropdown="dietary"] .dropdown-menu'
        );

        const selectedMarket = marketDropdown?.querySelector(
          ".dropdown-item.selected"
        );
        const selectedRegion = regionDropdown?.querySelector(
          ".dropdown-item.selected"
        );
        const selectedCuisine = cuisineDropdown?.querySelector(
          ".dropdown-item.selected"
        );
        const selectedDietary = dietaryDropdown?.querySelector(
          ".dropdown-item.selected"
        );

        return {
          marketId:
            selectedMarket?.getAttribute("data-value") === "all"
              ? null
              : selectedMarket?.getAttribute("data-market-id"),
          regionId:
            selectedRegion?.getAttribute("data-value") === "all"
              ? null
              : selectedRegion?.getAttribute("data-value"),
          cuisineId:
            selectedCuisine?.getAttribute("data-value") === "all"
              ? null
              : selectedCuisine?.getAttribute("data-value"),
          dietaryId:
            selectedDietary?.getAttribute("data-value") === "all"
              ? null
              : selectedDietary?.getAttribute("data-value"),
        };
      }

      function filterAndDisplayRestaurants(resetPage = true) {
        const filters = getSelectedFilters();
        let filtered = [...allRestaurants];

        // Filter by market (cities field)
        if (filters.marketId) {
          filtered = filtered.filter((restaurant) => {
            const cities = restaurant.fieldData?.cities || [];
            return Array.isArray(cities) && cities.includes(filters.marketId);
          });
        }

        // Filter by region (regions-category field)
        if (filters.regionId) {
          filtered = filtered.filter((restaurant) => {
            const regions = restaurant.fieldData?.["regions-category"] || [];
            return Array.isArray(regions) && regions.includes(filters.regionId);
          });
        }

        // Extract unique cuisine and dietary IDs from filtered restaurants
        // (before applying cuisine/dietary filters so dropdowns show all available options)
        const availableCuisineIds = new Set();
        const availableDietaryIds = new Set();

        filtered.forEach((restaurant) => {
          const cuisines = restaurant.fieldData?.["cusiness-category"] || [];
          const dietaries = restaurant.fieldData?.["dietary-category"] || [];

          if (Array.isArray(cuisines)) {
            cuisines.forEach((id) => availableCuisineIds.add(id));
          }
          if (Array.isArray(dietaries)) {
            dietaries.forEach((id) => availableDietaryIds.add(id));
          }
        });

        // Update cuisines and dietaries dropdowns to show only available options
        populateCuisinesDropdown(availableCuisineIds);
        populateDietariesDropdown(availableDietaryIds);

        // Filter by cuisine (cusiness-category field)
        if (filters.cuisineId) {
          filtered = filtered.filter((restaurant) => {
            const cuisines = restaurant.fieldData?.["cusiness-category"] || [];
            return (
              Array.isArray(cuisines) && cuisines.includes(filters.cuisineId)
            );
          });
        }

        // Filter by dietary (dietary-category field)
        if (filters.dietaryId) {
          filtered = filtered.filter((restaurant) => {
            const dietaries = restaurant.fieldData?.["dietary-category"] || [];
            return (
              Array.isArray(dietaries) && dietaries.includes(filters.dietaryId)
            );
          });
        }

        // Reset to page 1 when filters change (but not when just changing pages)
        if (resetPage) {
          currentPage = 1;
        }

        // Calculate pagination
        const totalPages = Math.ceil(filtered.length / restaurantsPerPage);
        // Ensure currentPage doesn't exceed totalPages
        if (currentPage > totalPages && totalPages > 0) {
          currentPage = totalPages;
        }
        const startIndex = (currentPage - 1) * restaurantsPerPage;
        const endIndex = startIndex + restaurantsPerPage;
        const paginatedRestaurants = filtered.slice(startIndex, endIndex);

        // Display restaurants
        const cardsGrid = document.getElementById("cards-grid");
        if (paginatedRestaurants.length === 0) {
          cardsGrid.innerHTML =
            '<div style="text-align: center; padding: 40px;">No restaurants found.</div>';
        } else {
          cardsGrid.innerHTML = paginatedRestaurants
            .map((item) => createCardHTML(item))
            .join("");
        }

        // Update pagination UI
        updatePaginationUI(totalPages, filtered.length);
      }

      function updatePaginationUI(totalPages, totalItems) {
        const paginationContainer = document.querySelector(".pagination");
        if (!paginationContainer) return;

        if (totalPages <= 1) {
          paginationContainer.innerHTML = "";
          return;
        }

        let html = `<button class="pagination-button prev" ${
          currentPage === 1 ? "disabled" : ""
        }>&lt;</button>`;

        // Show page numbers
        const maxVisiblePages = 7;
        let startPage = Math.max(1, currentPage - 3);
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage < maxVisiblePages - 1) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        if (startPage > 1) {
          html += `<button class="pagination-button" data-page="1">1</button>`;
          if (startPage > 2) {
            html += `<button class="pagination-button ellipsis">...</button>`;
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          html += `<button class="pagination-button ${
            i === currentPage ? "active" : ""
          }" data-page="${i}">${i}</button>`;
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            html += `<button class="pagination-button ellipsis">...</button>`;
          }
          html += `<button class="pagination-button" data-page="${totalPages}">${totalPages}</button>`;
        }

        html += `<button class="pagination-button next" ${
          currentPage === totalPages ? "disabled" : ""
        }>&gt;</button>`;

        paginationContainer.innerHTML = html;

        // Add event listeners
        paginationContainer
          .querySelectorAll(".pagination-button")
          .forEach((button) => {
            if (button.disabled) return;

            button.addEventListener("click", () => {
              const page = button.getAttribute("data-page");
              if (page) {
                currentPage = parseInt(page);
                filterAndDisplayRestaurants(false); // Don't reset page when paginating
              } else if (button.classList.contains("prev")) {
                if (currentPage > 1) {
                  currentPage--;
                  filterAndDisplayRestaurants(false); // Don't reset page when paginating
                }
              } else if (button.classList.contains("next")) {
                if (currentPage < totalPages) {
                  currentPage++;
                  filterAndDisplayRestaurants(false); // Don't reset page when paginating
                }
              }
            });
          });
      }

      function initializeDropdownEvents() {
        const dropdowns = document.querySelectorAll(".dropdown");
        console.log("Initializing dropdowns, count:", dropdowns.length);

        dropdowns.forEach((dropdown) => {
          // Skip if already initialized
          if (dropdown.dataset.initialized === "true") {
            console.log(
              "Skipping already initialized dropdown:",
              dropdown.dataset.dropdown
            );
            return;
          }

          const button = dropdown.querySelector(".dropdown-button");
          const menu = dropdown.querySelector(".dropdown-menu");

          if (!button || !menu) {
            console.warn("Dropdown button or menu not found", dropdown);
            return;
          }

          console.log(
            "Initializing dropdown:",
            dropdown.dataset.dropdown,
            "Button:",
            button,
            "Menu:",
            menu
          );

          // Mark as initialized
          dropdown.dataset.initialized = "true";

          // Toggle dropdown on button click
          // Use event delegation or attach directly - don't clone as it breaks references
          button.addEventListener("click", function (e) {
            e.stopPropagation();
            e.preventDefault();

            // Close all other dropdowns first
            const allDropdowns = document.querySelectorAll(".dropdown");
            allDropdowns.forEach((otherDropdown) => {
              if (otherDropdown !== dropdown) {
                otherDropdown.classList.remove("active");
              }
            });

            // Toggle current dropdown
            dropdown.classList.toggle("active");
          });

          // Handle item selection using event delegation on the menu
          // This works for both static and dynamically added items
          menu.addEventListener("click", function (e) {
            const item = e.target.closest(".dropdown-item");
            if (!item) return;

            e.stopPropagation();
            e.preventDefault();

            // Get all items in this dropdown (including dynamically added ones)
            const items = menu.querySelectorAll(".dropdown-item");

            // Remove selected class from all items in this dropdown
            items.forEach((i) => i.classList.remove("selected"));

            // Add selected class to clicked item
            item.classList.add("selected");

            // Update button text
            button.textContent = item.textContent.trim();

            dropdown.classList.remove("active");

            // If market dropdown was changed, update regions dropdown
            if (dropdown.dataset.dropdown === "market") {
              const selectedValue = item.getAttribute("data-value");
              const selectedMarketName =
                selectedValue === "all"
                  ? null
                  : item.getAttribute("data-market-name");
              populateRegionsDropdown(selectedMarketName);

              // Reset regions dropdown button text
              const regionsButton = document.querySelector(
                '[data-dropdown="regions"] .dropdown-button'
              );
              if (regionsButton) {
                regionsButton.textContent = "Regions Available";
              }

              // Reset regions selection
              const regionsMenu = document.querySelector(
                '[data-dropdown="regions"] .dropdown-menu'
              );
              if (regionsMenu) {
                const allRegionsItem =
                  regionsMenu.querySelector('[data-value="all"]');
                if (allRegionsItem) {
                  regionsMenu
                    .querySelectorAll(".dropdown-item")
                    .forEach((i) => i.classList.remove("selected"));
                  allRegionsItem.classList.add("selected");
                }
              }
            }

            // Filter restaurants when any filter changes
            if (allRestaurants.length > 0) {
              filterAndDisplayRestaurants();
            }
          });
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM Content Loaded");

        // Initialize dropdown functionality first (event delegation will handle dynamic items)
        initializeDropdownEvents();
        console.log("Dropdown events initialized");

        // Close all dropdowns when clicking outside
        document.addEventListener("click", function (e) {
          // Check if click is outside any dropdown
          const clickedDropdown = e.target.closest(".dropdown");
          if (!clickedDropdown) {
            const allDropdowns = document.querySelectorAll(".dropdown");
            allDropdowns.forEach((dropdown) => {
              dropdown.classList.remove("active");
            });
          }
        });

        // Load all data from Webflow CMS
        Promise.all([
          loadMarkets(),
          loadRegions(),
          loadCuisines(),
          loadDietaries(),
        ])
          .then(() => {
            console.log("Markets, regions, cuisines, and dietaries loaded");
            // Populate cuisines and dietaries dropdowns
            populateCuisinesDropdown();
            populateDietariesDropdown();
            // Load restaurants after everything else is ready
            return loadAllRestaurants();
          })
          .then(() => {
            console.log("All data loaded successfully");
          })
          .catch((error) => {
            console.error("Failed to load data:", error);
          });
      });
    </script>
  </body>
</html>
